#!/bin/bash

# –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Redis Cluster –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
# –ò–º–∏—Ç–∏—Ä—É–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–±–æ—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∞ —Å–ª–æ—Ç–æ–≤

set -e

echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ Redis Cluster –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"
echo "=========================================="

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ª–æ–≥ —Ñ–∞–π–ª
TEST_LOG="/tmp/redis_cluster_test.log"
echo "" > "$TEST_LOG"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤
test_alert_function() {
    echo "üìã –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤"
    
    # –ö–æ–ø–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é send_alert –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
    send_alert() {
        local message="$1"
        local level="$2"
        local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
        
        echo "[$timestamp] [$level] $message" >> "$TEST_LOG"
        echo "ALERT: $message"
    }
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –∞–ª–µ—Ä—Ç–æ–≤ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π
    send_alert "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ INFO" "INFO" | tee -a "$TEST_LOG"
    send_alert "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ WARNING" "WARNING" | tee -a "$TEST_LOG"
    send_alert "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ CRITICAL" "CRITICAL" | tee -a "$TEST_LOG"
    send_alert "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ERROR" "ERROR" | tee -a "$TEST_LOG"
    
    echo "‚úÖ –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–∫—Ä—ã—Ç–∏—è —Å–ª–æ—Ç–æ–≤ (–º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ)
test_slot_coverage_mock() {
    echo "üìã –¢–µ—Å—Ç 2: –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–∫—Ä—ã—Ç–∏—è —Å–ª–æ—Ç–æ–≤"
    
    # –°–æ–∑–¥–∞–µ–º –º–æ–∫ —Ñ—É–Ω–∫—Ü–∏–∏ check_slot_coverage
    mock_check_slot_coverage() {
        local scenario="$1"
        
        case "$scenario" in
            "full_coverage")
                echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è —Å–ª–æ—Ç–æ–≤ Redis Cluster - $(date) ==="
                echo "–°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞: ok"
                echo "–ü–æ–∫—Ä—ã—Ç–æ —Å–ª–æ—Ç–æ–≤: 16384/16384"
                echo "‚úì –í—Å–µ —Å–ª–æ—Ç—ã –ø–æ–∫—Ä—ã—Ç—ã (16384/16384)"
                ;;
            "partial_coverage")
                echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è —Å–ª–æ—Ç–æ–≤ Redis Cluster - $(date) ==="
                echo "–°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞: ok"
                echo "–ü–æ–∫—Ä—ã—Ç–æ —Å–ª–æ—Ç–æ–≤: 16001/16384"
                echo "ALERT: –ß–∞—Å—Ç–∏—á–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Å–ª–æ—Ç–æ–≤: 16001/16384"
                ;;
            "critical_coverage")
                echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è —Å–ª–æ—Ç–æ–≤ Redis Cluster - $(date) ==="
                echo "–°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞: fail"
                echo "–ü–æ–∫—Ä—ã—Ç–æ —Å–ª–æ—Ç–æ–≤: 8000/16384"
                echo "ALERT: –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –ø–æ–∫—Ä—ã—Ç–æ —Ç–æ–ª—å–∫–æ 8000/16384 —Å–ª–æ—Ç–æ–≤"
                ;;
            "error")
                echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è —Å–ª–æ—Ç–æ–≤ Redis Cluster - $(date) ==="
                echo "ALERT: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∞—Å—Ç–µ—Ä–µ Redis"
                ;;
        esac
    }
    
    echo "üîπ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Å–ª–æ—Ç–æ–≤:"
    mock_check_slot_coverage "full_coverage" | tee -a "$TEST_LOG"
    echo ""
    
    echo "üîπ –¢–µ—Å—Ç–∏—Ä—É–µ–º —á–∞—Å—Ç–∏—á–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ (WARNING):"
    mock_check_slot_coverage "partial_coverage" | tee -a "$TEST_LOG"
    echo ""
    
    echo "üîπ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ (CRITICAL):"
    mock_check_slot_coverage "critical_coverage" | tee -a "$TEST_LOG"
    echo ""
    
    echo "üîπ –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
    mock_check_slot_coverage "error" | tee -a "$TEST_LOG"
    echo ""
    
    echo "‚úÖ –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–∫—Ä—ã—Ç–∏—è —Å–ª–æ—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ —Å–∫—Ä–∏–ø—Ç–∞
test_syntax_validation() {
    echo "üìã –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ —Å–∫—Ä–∏–ø—Ç–∞"
    
    echo "üîπ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é —Å–∫—Ä–∏–ø—Ç–∞:"
    if bash -n redis/scripts/cluster_slot_monitor_local.sh; then
        echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å cluster_slot_monitor_local.sh –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –≤ cluster_slot_monitor_local.sh"
        exit 1
    fi
    
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Ä–æ–≥–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
test_threshold_values() {
    echo "üìã –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä–æ–≥–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π"
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞
    ALERT_THRESHOLD=$(grep -oP 'ALERT_THRESHOLD=\K[0-9]+' redis/scripts/cluster_slot_monitor_local.sh)
    WARNING_THRESHOLD=$(grep -oP 'WARNING_THRESHOLD=\K[0-9]+' redis/scripts/cluster_slot_monitor_local.sh)
    
    echo "üîπ ALERT_THRESHOLD: $ALERT_THRESHOLD (–æ–∂–∏–¥–∞–µ—Ç—Å—è: 16384)"
    echo "üîπ WARNING_THRESHOLD: $WARNING_THRESHOLD (–æ–∂–∏–¥–∞–µ—Ç—Å—è: 16000)"
    
    if [ "$ALERT_THRESHOLD" -eq 16384 ] && [ "$WARNING_THRESHOLD" -eq 16000 ]; then
        echo "‚úÖ –ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã"
    else
        echo "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è"
        exit 1
    fi
    
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ø–∏—Å–∫–∞ –Ω–æ–¥
test_node_list() {
    echo "üìã –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–∏—Å–∫–∞ –Ω–æ–¥ –∫–ª–∞—Å—Ç–µ—Ä–∞"
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–ø–∏—Å–æ–∫ –Ω–æ–¥ –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞
    NODES_LINE=$(grep -A 1 'nodes=(' redis/scripts/cluster_slot_monitor_local.sh | grep -o '".*"' | tr -d '"')
    echo "üîπ –°–ø–∏—Å–æ–∫ –Ω–æ–¥: $NODES_LINE"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å 6 –Ω–æ–¥ (3 –º–∞—Å—Ç–µ—Ä–∞ + 3 —Ä–µ–ø–ª–∏–∫–∏)
    NODE_COUNT=$(echo "$NODES_LINE" | tr ' ' '\n' | grep -c "localhost:")
    echo "üîπ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–¥: $NODE_COUNT (–æ–∂–∏–¥–∞–µ—Ç—Å—è: 6)"
    
    if [ "$NODE_COUNT" -eq 6 ]; then
        echo "‚úÖ –°–ø–∏—Å–æ–∫ –Ω–æ–¥ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
    else
        echo "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–¥"
        exit 1
    fi
    
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å AlertService
test_alert_service_integration() {
    echo "üìã –¢–µ—Å—Ç 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å AlertService"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è Telegram
    TELEGRAM_CODE=$(grep -c "TELEGRAM_BOT_TOKEN" redis/scripts/cluster_slot_monitor_local.sh)
    if [ "$TELEGRAM_CODE" -gt 0 ]; then
        echo "‚úÖ –ö–æ–¥ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Telegram –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω)"
    else
        echo "‚ö†Ô∏è –ö–æ–¥ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Telegram –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª
    LOG_FILE=$(grep -oP 'LOG_FILE=\K[^ ]+' redis/scripts/cluster_slot_monitor_local.sh)
    echo "üîπ –õ–æ–≥ —Ñ–∞–π–ª: $LOG_FILE"
    
    echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    echo ""
}

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
main() {
    echo "üöÄ –ù–∞—á–∞–ª–æ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Redis Cluster –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"
    echo "=========================================================="
    
    test_syntax_validation
    test_threshold_values
    test_node_list
    test_alert_function
    test_slot_coverage_mock
    test_alert_service_integration
    
    echo "=========================================================="
    echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
    echo ""
    echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
    echo "   - –°–∏–Ω—Ç–∞–∫—Å–∏—Å —Å–∫—Ä–∏–ø—Ç–∞: ‚úÖ"
    echo "   - –ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: ‚úÖ"
    echo "   - –°–ø–∏—Å–æ–∫ –Ω–æ–¥: ‚úÖ"
    echo "   - –§—É–Ω–∫—Ü–∏—è –∞–ª–µ—Ä—Ç–æ–≤: ‚úÖ"
    echo "   - –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: ‚úÖ"
    echo "   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: ‚úÖ"
    echo ""
    echo "üìã –õ–æ–≥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: $TEST_LOG"
    echo ""
    echo "–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏"
}

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
main "$@"