#!/bin/bash

# –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Cloudflare Tunnel –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
# –ò–º–∏—Ç–∏—Ä—É–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–±–æ—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∞ —Ç—É–Ω–Ω–µ–ª—è

set -e

echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ Cloudflare Tunnel –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"
echo "==============================================="

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ª–æ–≥ —Ñ–∞–π–ª
TEST_LOG="/tmp/cloudflare_tunnel_test.log"
echo "" > "$TEST_LOG"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤
test_alert_function() {
    echo "üìã –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤"
    
    # –ö–æ–ø–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é send_alert –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
    send_alert() {
        local message="$1"
        local level="$2"
        local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
        
        echo "[$timestamp] [$level] $message" >> "$TEST_LOG"
        echo "CLOUDFLARED ALERT: $message"
    }
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –∞–ª–µ—Ä—Ç–æ–≤ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π
    send_alert "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ INFO" "INFO" | tee -a "$TEST_LOG"
    send_alert "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ WARNING" "WARNING" | tee -a "$TEST_LOG"
    send_alert "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ CRITICAL" "CRITICAL" | tee -a "$TEST_LOG"
    
    echo "‚úÖ –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ —Å–∫—Ä–∏–ø—Ç–∞
test_syntax_validation() {
    echo "üìã –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ —Å–∫—Ä–∏–ø—Ç–∞"
    
    echo "üîπ –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:"
    if bash -n cloudflare/tunnel_monitor.sh; then
        echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å tunnel_monitor.sh –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –≤ tunnel_monitor.sh"
        exit 1
    fi
    
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
test_config_parameters() {
    echo "üìã –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤"
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞
    CHECK_INTERVAL=$(grep -oP 'CHECK_INTERVAL=\K[0-9]+' cloudflare/tunnel_monitor.sh)
    MAX_RETRIES=$(grep -oP 'MAX_RETRIES=\K[0-9]+' cloudflare/tunnel_monitor.sh)
    LOG_FILE=$(grep -oP 'LOG_FILE=\K[^ ]+' cloudflare/tunnel_monitor.sh)
    
    echo "üîπ CHECK_INTERVAL: $CHECK_INTERVAL (–æ–∂–∏–¥–∞–µ—Ç—Å—è: 30)"
    echo "üîπ MAX_RETRIES: $MAX_RETRIES (–æ–∂–∏–¥–∞–µ—Ç—Å—è: 3)" 
    echo "üîπ LOG_FILE: $LOG_FILE (–æ–∂–∏–¥–∞–µ—Ç—Å—è: /var/log/cloudflared-monitor.log)"
    
    if [ "$CHECK_INTERVAL" -eq 30 ] && [ "$MAX_RETRIES" -eq 3 ]; then
        echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã"
    else
        echo "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"
        exit 1
    fi
    
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Ç—É–Ω–Ω–µ–ª—è
test_tunnel_status_mock() {
    echo "üìã –¢–µ—Å—Ç 4: –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Ç—É–Ω–Ω–µ–ª—è"
    
    # –ú–æ–∫ —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
    mock_check_tunnel_status() {
        local scenario="$1"
        
        case "$scenario" in
            "healthy")
                echo "=== Cloudflare Tunnel Check - $(date) ==="
                echo "–°—Ç–∞—Ç—É—Å —Ç—É–Ω–Ω–µ–ª—è: active"
                echo "–í—Å–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π: 5"
                echo "–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: 3"
                ;;
            "degraded")
                echo "=== Cloudflare Tunnel Check - $(date) ==="
                echo "–°—Ç–∞—Ç—É—Å —Ç—É–Ω–Ω–µ–ª—è: degraded"
                echo "–í—Å–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π: 2"
                echo "–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: 1"
                ;;
            "inactive")
                echo "=== Cloudflare Tunnel Check - $(date) ==="
                echo "–°—Ç–∞—Ç—É—Å —Ç—É–Ω–Ω–µ–ª—è: inactive"
                echo "–í—Å–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π: 0"
                echo "–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: 0"
                ;;
            "unknown")
                echo "=== Cloudflare Tunnel Check - $(date) ==="
                echo "–°—Ç–∞—Ç—É—Å —Ç—É–Ω–Ω–µ–ª—è: unknown"
                echo "–í—Å–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π: 0"
                echo "–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: 0"
                ;;
        esac
    }
    
    echo "üîπ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–¥–æ—Ä–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å —Ç—É–Ω–Ω–µ–ª—è:"
    mock_check_tunnel_status "healthy" | tee -a "$TEST_LOG"
    echo ""
    
    echo "üîπ –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞–≤—à–∏–π —Å—Ç–∞—Ç—É—Å:"
    mock_check_tunnel_status "degraded" | tee -a "$TEST_LOG"
    echo ""
    
    echo "üîπ –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ç–∞—Ç—É—Å:"
    mock_check_tunnel_status "inactive" | tee -a "$TEST_LOG"
    echo ""
    
    echo "üîπ –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å:"
    mock_check_tunnel_status "unknown" | tee -a "$TEST_LOG"
    echo ""
    
    echo "‚úÖ –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Ç—É–Ω–Ω–µ–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
test_service_list() {
    echo "üìã –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞
    SERVICES_LINE=$(grep -A 5 'local services=(' cloudflare/tunnel_monitor.sh | grep -o '".*"' | tr -d '"' | tr '\n' ' ')
    SERVICE_NAMES=$(grep -A 2 'local service_names=(' cloudflare/tunnel_monitor.sh | grep -o '".*"' | tr -d '"' | tr '\n' ' ')
    
    echo "üîπ –°–µ—Ä–≤–∏—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏: $SERVICES_LINE"
    echo "üîπ –ò–º–µ–Ω–∞ —Å–µ—Ä–≤–∏—Å–æ–≤: $SERVICE_NAMES"
    
    SERVICE_COUNT=$(echo "$SERVICES_LINE" | tr ' ' '\n' | grep -c "http://")
    if [ "$SERVICE_COUNT" -eq 3 ]; then
        echo "‚úÖ –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω (3 —Å–µ—Ä–≤–∏—Å–∞)"
    else
        echo "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ä–≤–∏—Å–æ–≤: $SERVICE_COUNT"
        exit 1
    fi
    
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ DNS –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
test_dns_and_certificates() {
    echo "üìã –¢–µ—Å—Ç 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫"
    
    # –ú–æ–∫ —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ DNS
    echo "üîπ –¢–µ—Å—Ç–∏—Ä—É–µ–º DNS –ø—Ä–æ–≤–µ—Ä–∫–∏:"
    echo "‚úì DNS api.telegram.org: —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è"
    echo "‚úì DNS api.heleket.com: —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è" 
    echo "‚úì DNS cloudflare.com: —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è"
    echo ""
    
    # –ú–æ–∫ —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
    echo "üîπ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:"
    echo "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç /etc/cloudflared/cert.pem: –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 90 –¥–Ω–µ–π (Dec 12 12:00:00 2025 GMT)"
    echo "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç /etc/nginx/ssl/cert.pem: –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π (Oct 12 12:00:00 2025 GMT)"
    echo ""
    
    echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏ DNS –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω—ã"
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
test_integration_capabilities() {
    echo "üìã –¢–µ—Å—Ç 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
    TELEGRAM_CODE=$(grep -c "Telegram notifications" cloudflare/tunnel_monitor.sh)
    SLACK_CODE=$(grep -c "Slack webhook" cloudflare/tunnel_monitor.sh)
    EMAIL_CODE=$(grep -c "Email alerts" cloudflare/tunnel_monitor.sh)
    
    if [ "$TELEGRAM_CODE" -gt 0 ] && [ "$SLACK_CODE" -gt 0 ] && [ "$EMAIL_CODE" -gt 0 ]; then
        echo "‚úÖ –ö–æ–¥ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω)"
    else
        echo "‚ö†Ô∏è –ù–µ –≤—Å–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç"
    fi
    
    echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    echo ""
}

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
main() {
    echo "üöÄ –ù–∞—á–∞–ª–æ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Cloudflare Tunnel –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"
    echo "================================================================="
    
    test_syntax_validation
    test_config_parameters
    test_service_list
    test_alert_function
    test_tunnel_status_mock
    test_dns_and_certificates
    test_integration_capabilities
    
    echo "================================================================="
    echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
    echo ""
    echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
    echo "   - –°–∏–Ω—Ç–∞–∫—Å–∏—Å —Å–∫—Ä–∏–ø—Ç–∞: ‚úÖ"
    echo "   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: ‚úÖ"
    echo "   - –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤: ‚úÖ"
    echo "   - –§—É–Ω–∫—Ü–∏—è –∞–ª–µ—Ä—Ç–æ–≤: ‚úÖ"
    echo "   - –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç—É–Ω–Ω–µ–ª—è: ‚úÖ"
    echo "   - –ü—Ä–æ–≤–µ—Ä–∫–∏ DNS –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤: ‚úÖ"
    echo "   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: ‚úÖ"
    echo ""
    echo "üìã –õ–æ–≥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: $TEST_LOG"
    echo ""
    echo "–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏"
}

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
main "$@"